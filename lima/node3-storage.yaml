# node3: Storage / Cinder (+ Ceph OSD later)
# 12 GB RAM, 2 vCPU, 30 GB OS disk, 10 GB LVM disk, 20 GB Ceph OSD disk
# Networks: management, storage

vmType: qemu
arch: aarch64

cpus: 2
memory: 12GiB
disk: 30GiB

images:
  - location: https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img
    arch: aarch64

# Disable default mounts â€” not needed for OpenStack nodes
mounts: []

# Additional disks
additionalDisks:
  - name: node3-cinder-lvm
    format: false
  - name: node3-ceph-osd
    format: false

# Networks (2 interfaces)
networks:
  - lima: management
    interface: lima0
  - lima: storage
    interface: lima1

# SSH configuration
ssh:
  loadDotSSHPubKeys: false
  forwardAgent: false

# Cloud-init provisioning
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux

      # Configure static IPs on all interfaces via netplan
      cat > /etc/netplan/99-openstack.yaml << 'NETPLAN'
      network:
        version: 2
        ethernets:
          lima0:
            dhcp4: false
            addresses:
              - 192.168.105.12/24
            routes:
              - to: default
                via: 192.168.105.1
            nameservers:
              addresses:
                - 192.168.105.1
          lima1:
            dhcp4: false
            addresses:
              - 10.0.3.12/24
      NETPLAN

      # Apply network configuration
      netplan apply

      # Set hostname
      hostnamectl set-hostname node3.openstack.local
      echo "192.168.105.10 node1.openstack.local node1" >> /etc/hosts
      echo "192.168.105.11 node2.openstack.local node2" >> /etc/hosts
      echo "192.168.105.12 node3.openstack.local node3" >> /etc/hosts
      echo "192.168.105.250 controller.openstack.local controller" >> /etc/hosts

      # Inject project SSH key
      mkdir -p /root/.ssh
      echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICXZQrTAjCCJsVRa48otnNiEWPXYnzpXTeYEgnTiZb8S openstack-lab-deploy" >> /root/.ssh/authorized_keys
      chmod 600 /root/.ssh/authorized_keys

      # Also add key for the default lima user
      echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICXZQrTAjCCJsVRa48otnNiEWPXYnzpXTeYEgnTiZb8S openstack-lab-deploy" >> /home/$(ls /home/ | head -1)/.ssh/authorized_keys

      # Configure NTP
      timedatectl set-ntp true

      # Prepare LVM volume group for Cinder
      # The cinder-lvm disk will appear as /dev/vdb
      apt-get update
      apt-get install -y python3 python3-pip chrony lvm2
      pvcreate /dev/vdb
      vgcreate cinder-volumes /dev/vdb
